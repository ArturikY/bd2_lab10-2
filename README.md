# Лабораторная работа 10: Веб-приложение для дистанционного управления температурой устройства

## Описание проекта

Веб-приложение для дистанционного управления температурой устройств с использованием PHP и MySQL.

## Структура проекта

### Основные файлы:
- `config.php` - настройки подключения к базе данных
- `template.php` - шаблон представления состояния устройства
- `functions.php` - вспомогательные функции для работы с устройствами
- `device_status.php` - скрипт для получения статуса устройства (используется устройством)
- `history.php` - страница истории управления устройством

### Файлы для каждого задания:
- `index.php` - **Задание 1**: Базовое веб-приложение (одно устройство)
- `task2_index.php` - **Задание 2**: Подключение к БД и шаблон в отдельных файлах
- `task3_index.php` - **Задание 3**: Поддержка нескольких устройств на одной странице
- `task4_index.php` - **Задание 4**: Усовершенствованный механизм идентификации устройства (токены)
- `task5_index.php` - **Задание 5**: Учет действий пользователя и история управления
- `task6_index.php` - **Задание 6**: Триггер блокировки пользователя при частых обращениях
- `task7_index.php` - **Задание 7**: Триггер блокировки устройства при частых обращениях
- `task8_index.php` - **Задание 8**: Защита от SQL-инъекций

### База данных:
- `database_schema.sql` - SQL-скрипт для создания структуры базы данных и триггеров

## Статус выполнения заданий

### ✅ Задание 1 [1/8]
**Статус:** Выполнено  
**Файл:** `index.php`  
**Описание:** Базовое веб-приложение для управления одним устройством (ID = 1).  
**Функционал:**
- Отображение температуры и состояния реле
- Кнопки включения/выключения реле
- Подключение к базе данных через PDO

### ✅ Задание 2 [1/8]
**Статус:** Выполнено  
**Файл:** `task2_index.php`, `config.php`, `template.php`  
**Описание:** Подключение к БД и шаблон представления вынесены в отдельные файлы.  
**Функционал:**
- `config.php` - настройки подключения к БД
- `template.php` - функция `renderDeviceTemplate()` для формирования HTML
- Основная логика в `task2_index.php`

### ✅ Задание 3 [1/8]
**Статус:** Выполнено  
**Файл:** `task3_index.php`, `functions.php`  
**Описание:** Поддержка нескольких устройств на одной странице.  
**Функционал:**
- Отображение всех устройств пользователя
- Информация о каждом устройстве
- Элементы управления для каждого устройства
- Функция `getAllDevices()` для получения списка устройств

### ✅ Задание 4 [1/8]
**Статус:** Выполнено  
**Файл:** `task4_index.php`  
**Описание:** Усовершенствованный механизм идентификации устройства.  
**Функционал:**
- Идентификация устройства по токену (`DEVICE_TOKEN`)
- Использование сессий для сохранения токена
- Параметр `device_token` в URL для доступа к конкретному устройству
- Функция `getDeviceByToken()` для поиска устройства по токену

### ✅ Задание 5 [1/8]
**Статус:** Выполнено  
**Файл:** `task5_index.php`, `history.php`  
**Описание:** Учет действий пользователя и история управления.  
**Функционал:**
- Таблица `USER_ACTIONS` для учета действий пользователя
- Таблица `USERS` для хранения информации о пользователях
- Функция `logUserAction()` для логирования действий
- Страница `history.php` с историей управления устройством
- Ссылка на историю для каждого устройства

### ✅ Задание 6 [1/8]
**Статус:** Выполнено  
**Файл:** `task6_index.php`, `database_schema.sql`  
**Описание:** Триггер блокировки пользователя при частых обращениях.  
**Функционал:**
- Триггер `check_user_activity` проверяет частоту обращений
- Блокировка пользователя при более чем 10 действиях за минуту
- Блокировка на 5 минут
- Автоматическая разблокировка после истечения времени
- Заблокированным пользователям не показываются устройства и элементы управления
- Функция `isUserBlocked()` для проверки статуса блокировки

### ✅ Задание 7 [1/8]
**Статус:** Выполнено  
**Файл:** `task7_index.php`, `database_schema.sql`  
**Описание:** Триггер блокировки устройства при частых обращениях.  
**Функционал:**
- Триггер `check_device_activity` проверяет частоту обращений к устройству
- Блокировка устройства при более чем 5 обращениях за 30 секунд
- Поле `IS_BLOCKED` в таблице `DEVICE_TABLE`
- Пользователю показывается предупреждение о подозрительном поведении устройства
- Заблокированные устройства не могут быть управляемы
- Функция `isDeviceBlocked()` для проверки статуса блокировки

### ✅ Задание 8 [1/8]
**Статус:** Выполнено  
**Файл:** `task8_index.php`  
**Описание:** Защита от SQL-инъекций.  
**Функционал:**
- Все SQL-запросы используют prepared statements (PDO)
- Функция `sanitizeInput()` для валидации и очистки входных данных
- Использование `htmlspecialchars()` для защиты от XSS
- Использование `urlencode()` для безопасной передачи параметров в URL
- Валидация числовых параметров через `intval()`
- Все пользовательские данные экранируются перед выводом

## Установка и настройка

1. **Создание базы данных:**
   ```bash
   mysql -u root -p < database_schema.sql
   ```

2. **Настройка подключения:**
   Отредактируйте файл `config.php` и укажите параметры подключения к БД:
   - `$db_host` - хост БД
   - `$db_user` - пользователь БД
   - `$db_password` - пароль БД
   - `$database` - имя БД

3. **Запуск веб-сервера:**
   ```bash
   php -S localhost:8000
   ```

4. **Доступ к приложению:**
   - Задание 1: `http://localhost:8000/index.php`
   - Задание 2: `http://localhost:8000/task2_index.php`
   - Задание 3: `http://localhost:8000/task3_index.php`
   - Задание 4: `http://localhost:8000/task4_index.php?device_token=token_device_1`
   - Задание 5: `http://localhost:8000/task5_index.php`
   - Задание 6: `http://localhost:8000/task6_index.php`
   - Задание 7: `http://localhost:8000/task7_index.php`
   - Задание 8: `http://localhost:8000/task8_index.php`

## Структура базы данных

### Основные таблицы:
- `DEVICE_TABLE` - устройства
- `TEMPERATURE_TABLE` - температура устройств
- `OUT_STATE_TABLE` - состояние реле
- `COMMAND_TABLE` - команды управления
- `USERS` - пользователи
- `USER_ACTIONS` - история действий пользователей

### Триггеры:
- `check_user_activity` - блокировка пользователя при частых обращениях
- `check_device_activity` - блокировка устройства при частых обращениях

## Безопасность

- Все SQL-запросы используют prepared statements
- Входные данные валидируются и санитизируются
- Защита от XSS через `htmlspecialchars()`
- Защита от SQL-инъекций через PDO
- Блокировка при подозрительной активности

## Примечания

- По умолчанию используется пользователь с `USER_ID = 1`
- Для задания 4 можно использовать токены устройств из таблицы `DEVICE_TABLE`
- Триггеры автоматически блокируют пользователей и устройства при превышении лимитов
- История действий хранится в таблице `USER_ACTIONS`

